<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ProxLB Web Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <h1 class="mb-3">ProxLB Web Dashboard</h1>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-info">{{ messages[0] }}</div>
    {% endif %}
  {% endwith %}

  <h3>Cluster Nodes</h3>
  <table class="table table-bordered align-middle">
    <thead><tr><th>Node</th><th>Status</th><th>CPU %</th><th>RAM %</th></tr></thead>
    <tbody>
      {% for n in nodes %}
      <tr>
        <td>{{ n.node }}</td>
        <td>{{ n.status }}</td>
        <td>{{ n.cpu_pct }}%</td>
        <td>{{ n.mem_pct }}%</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h3>VMs</h3>
  <table class="table table-striped align-middle" id="vm-table">
    <thead>
      <tr><th>ID</th><th>Name</th><th>Node</th><th>Type</th><th>Status</th><th style="width: 260px;">Actions</th></tr>
    </thead>
    <tbody>
      {% for v in vms %}
      <tr data-vmid="{{ v.vmid }}" data-node="{{ v.node }}">
        <td>{{ v.vmid }}</td>
        <td>{{ v.name }}</td>
        <td class="vm-node">{{ v.node }}</td>
        <td>{{ v.type }}</td>
        <td class="vm-status">
          <span class="badge {{ 'bg-success' if v.status=='running' else 'bg-secondary' }}">{{ v.status }}</span>
        </td>
        <td>
          <form action="/api/action/{{ v.node }}/{{ v.vmid }}/start" method="post" class="d-inline">
            <button class="btn btn-sm btn-success" {{ 'disabled' if v.status=='running' else '' }}>Start</button>
          </form>
          <form action="/api/action/{{ v.node }}/{{ v.vmid }}/reboot" method="post" class="d-inline">
            <button class="btn btn-sm btn-warning" {{ 'disabled' if v.status!='running' else '' }}>Reboot</button>
          </form>
          <form action="/api/action/{{ v.node }}/{{ v.vmid }}/stop" method="post" class="d-inline">
            <button class="btn btn-sm btn-danger" {{ 'disabled' if v.status!='running' else '' }}>Stop</button>
          </form>

          <button class="btn btn-sm btn-primary btn-migrate">Migrate</button>

          <div class="progress mt-2 d-none" style="height: 20px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                 style="width: 0%;">0%</div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
  async function postJSON(url='', data={}) {
    const r = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
    return r.json();
  }
  async function getJSON(url='') { const r = await fetch(url); return r.json(); }

  async function startMigration(row) {
    const vmid = row.dataset.vmid, node = row.dataset.node;
    const res = await postJSON('/api/migrate', { vmid, node });
    if (res.error) { alert('Migrate error: ' + res.error); return; }

    const btn = row.querySelector('.btn-migrate');
    const progWrap = row.querySelector('.progress');
    const prog = row.querySelector('.progress-bar');
    btn.classList.add('d-none'); progWrap.classList.remove('d-none');
    prog.style.width = '0%'; prog.textContent = '0%';

    const upid = res.upid, taskNode = node;
    let done = false, startIdx = 0;

    while (!done) {
      await new Promise(r => setTimeout(r, 1500));
      const st = await getJSON(`/api/task_status?node=${encodeURIComponent(taskNode)}&upid=${encodeURIComponent(upid)}&start=${startIdx}`);
      if (st.error) { prog.classList.add('bg-danger'); prog.textContent = 'error'; break; }

      if (typeof st.next_start === 'number') startIdx = st.next_start;

      if (typeof st.percent === 'number') {
        const pct = Math.max(0, Math.min(100, st.percent));
        prog.style.width = pct + '%'; prog.textContent = pct + '%';
      } else {
        prog.classList.add('progress-bar-animated'); prog.textContent = '...';
      }

      const status = st.status, exitstatus = (st.exitstatus || '').toUpperCase();
      if (status === 'stopped') {
        done = true; prog.classList.remove('progress-bar-animated');
        if (exitstatus === 'OK') { prog.classList.add('bg-success'); prog.style.width = '100%'; prog.textContent = '100%'; setTimeout(()=>location.reload(), 1200); }
        else { prog.classList.add('bg-danger'); prog.textContent = exitstatus || 'failed'; }
      }
    }
  }

  document.querySelectorAll('.btn-migrate').forEach(btn => btn.addEventListener('click', (e) => {
    const row = e.target.closest('tr'); startMigration(row);
  }));
  </script>
</body>
</html>
